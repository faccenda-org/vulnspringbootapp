name: Auto-merge Dependabot PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

env:
  MERGE_METHOD: squash
  workflow_dispatch:
    inputs:
      compat_threshold:
        description: "Override compatibility threshold (percent) for this run"
        required: false
        type: string
  DEFAULT_COMPAT_THRESHOLD: "80"
  NO_AUTO_MERGE_LABEL: no-auto-merge

jobs:
  check-and-merge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub

      - name: Decide and merge or comment (Python)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PYCODE'
          import os
          import re
          import json
          from github import Github

          # Read event payload
          event_path = os.environ.get('GITHUB_EVENT_PATH')
          with open(event_path, 'r', encoding='utf-8') as f:
            event = json.load(f)

          pr = event.get('pull_request', {})
          title = pr.get('title') or ''
          body = pr.get('body') or ''

          def parse_version(v: str):
            m = re.match(r'^(\d+)\.(\d+)\.(\d+)(?:[-+].*)?$', v.strip())
            if not m:
              return None
            return {'major': int(m.group(1)), 'minor': int(m.group(2)), 'patch': int(m.group(3))}

          bump_match = re.search(r'Bump\s+.+\s+from\s+([0-9]+\.[0-9]+\.[0-9]+)\s+to\s+([0-9]+\.[0-9]+\.[0-9]+)', title, re.IGNORECASE)
          upgrade_type = 'unknown'
          if bump_match:
            from_v = parse_version(bump_match.group(1))
            to_v = parse_version(bump_match.group(2))
            if from_v and to_v:
              if to_v['major'] != from_v['major']:
                upgrade_type = 'major'
              elif to_v['minor'] != from_v['minor']:
                upgrade_type = 'minor'
              elif to_v['patch'] != from_v['patch']:
                upgrade_type = 'patch'

          compat_score = None
          # Allow manual dispatch input to override threshold for testing
          dispatch_threshold = event.get('inputs', {}).get('compat_threshold') if isinstance(event.get('inputs'), dict) else None
          re_list = [
            dispatch_threshold
            or os.environ.get('DEPENDABOT_COMPAT_THRESHOLD')
            re.compile(r'Compatibility\s+score\s*[:|-]?\s*(\d{1,3})%', re.IGNORECASE),
            re.compile(r'Update\s+confidence[\s\S]*?(\d{1,3})%', re.IGNORECASE),
            re.compile(r'Confidence[\s\S]*?(\d{1,3})%', re.IGNORECASE),
          ]
          for rx in re_list:
            m = rx.search(body or '')
            if m:
              try:
                compat_score = int(m.group(1))
                break
              except ValueError:
                pass

          threshold_str = os.environ.get('DEPENDABOT_COMPAT_THRESHOLD') or os.environ.get('DEFAULT_COMPAT_THRESHOLD') or '80'
          try:
            threshold = int(threshold_str)
          except ValueError:
            threshold = 80

          reason_parts = [
            f"upgrade type: {upgrade_type}",
            f"compatibility score: {str(compat_score) + '%' if compat_score is not None else 'not found'}",
            f"threshold: {threshold}%",
          ]

          should_merge = (
            (upgrade_type == 'patch') or
            (upgrade_type == 'minor' and compat_score is not None and compat_score >= threshold)
          )

          repo_full = os.environ.get('GITHUB_REPOSITORY')
          owner, repo_name = repo_full.split('/')
          pull_number = pr.get('number')

          gh = Github(os.environ['GITHUB_TOKEN'])
          repo = gh.get_repo(repo_full)
          issue = repo.get_issue(number=pull_number)
          pr_obj = repo.get_pull(number=pull_number)

          # Skip if PR has configured no-auto-merge label
          skip_label = os.environ.get('NO_AUTO_MERGE_LABEL', 'no-auto-merge').lower()
          label_names = [lbl.name for lbl in pr_obj.get_labels()]
          if skip_label in [name.lower() for name in label_names]:
            body_comment = (
              f"Skipping auto-merge due to '{skip_label}' label.\n\nDetails:\n- "
              + "\n- ".join(reason_parts)
            )
            issue.create_comment(body_comment)
            print(f"Auto-merge skipped: '{skip_label}' label present.")
            raise SystemExit(0)

          if should_merge:
            merge_method = os.environ.get('MERGE_METHOD', 'squash')
            try:
              pr_obj.merge(merge_method=merge_method)
              print(f"Merged PR #{pull_number} with method {merge_method}")
            except Exception as e:
              body_comment = (
                "Auto-merge attempt failed.\n\nDetails:\n- "
                + "\n- ".join(reason_parts)
                + f"\n\nError: {str(e)}"
              )
              issue.create_comment(body_comment)
              raise
          else:
            body_comment = (
              "Requires manual review.\n\nDetails:\n- "
              + "\n- ".join(reason_parts)
            )
            issue.create_comment(body_comment)
            print('Posted manual review comment.')
          PYCODE

      - name: Output summary
        if: always()
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Title: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "Actor: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Merge method: $MERGE_METHOD" >> $GITHUB_STEP_SUMMARY
