name: Auto-merge Dependabot PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      compat_threshold:
        description: "Override compatibility threshold (percent) for this run"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  MERGE_METHOD: squash
  DEFAULT_COMPAT_THRESHOLD: "80"
  NO_AUTO_MERGE_LABEL: no-auto-merge

jobs:
  skip-non-dependabot:
    if: ${{ github.actor != 'dependabot[bot]' && github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Skip workflow for non-Dependabot actors
        run: echo "Skipping: actor is not Dependabot and this is not a manual dispatch."

  check-and-merge:
    if: ${{ github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub

      - name: Decide and merge or comment (Python)
        id: decision
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMPAT_THRESHOLD: ${{ github.event.inputs.compat_threshold || env.DEFAULT_COMPAT_THRESHOLD }}
        run: |
          python scripts/auto_merge.py

      - name: Enable PR auto-merge
        if: ${{ steps.decision.outputs.MERGE_ALLOWED == 'true' }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          merge-method: ${{ env.MERGE_METHOD }}

      - name: Output summary
        if: always()
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Title: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "Actor: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "Merge method: $MERGE_METHOD" >> $GITHUB_STEP_SUMMARY
